# AgentSpaces — Agents as stateful graphs

Short description
-----------------
AgentSpaces is a developer framework containing example "agentic" workflows implemented as stateful graphs. Each agent in `agents/` is a small, composable workflow made of nodes (pure functions) that operate on a shared Pydantic `State` and optionally call external tools (LLMs, Google Sheets, GitLab, databases) via an MCP adapter.

This repo is intended for engineers who want to prototype, test, and extend agent-based automation for data-platform tasks (for example: migrating DBT logic, extracting metadata, generating SQL/YAML artifacts from LLMs).

Quick links
-----------
- Agents folder: `agents/` (place to add or browse agents)
- Example agent: `agents/DpxToClickhouse/` (fully working example)
- Documentation: `documents/` (detailed English guides and fundamentals)
- Configs: `variables/` (project config loaders)
- MCP adapters: `framework/mcp_adapters/`

Repository structure (high-level)
--------------------------------
- `agents/` — each subfolder is an agent and typically contains:
  - `context.py` — shared context (LLM adapters, MCP client, config)
  - `node_functions.py` — Pydantic State and node implementations
  - `graph.py` — builds StateGraph, router, debug runner
  - `prompts.md` — prompt templates
  - `output_files/` — generated artifacts
- `documents/` — human-readable guides (how to run, create agents, fundamentals)
- `utils/` — helper utilities (prompt loader, LLM wrappers, gitlab helpers, etc.)
- `framework/` — adapters (MCP client wrappers and server glue)
- `variables/` — configuration classes and loaders
- `requirements.txt` — Python dependencies

Getting started (quick)
-----------------------
1. Create and activate a virtual environment (zsh):

```bash
python -m venv .venv
source .venv/bin/activate
```

2. Install dependencies:

```bash
pip install -r requirements.txt
```

3. Provide configuration (example envs) — you can create a `local.env` or export variables directly. Example variables used by `DpxToClickhouse`:

```bash
export DPX2CLICKHOUSE_MAPPING_STAGING_TO_DPX_SHEET='<your-mapping-sheet-id>'
export DPX2CLICKHOUSE_PII_COLUMNS_SHEET='<your-pii-sheet-id>'
export DPX2CLICKHOUSE_DBT_CLICKHOUSE_REPO='group/project-clickhouse'
export DPX2CLICKHOUSE_DBT_TRINO_REPO='group/project-dpx'
```

4. Run the example agent (debug runner):

```bash
python agents/DpxToClickhouse/graph.py
```

Programmatic run (Python):

```python
from agents.DpxToClickhouse.graph import run_workflow
import asyncio
asyncio.run(run_workflow())
```

Where outputs go
----------------
Generated SQL and YAML files are written to the agent's `output_files/` folder (e.g. `agents/DpxToClickhouse/output_files/`) by default. You can override this by setting `ctx.output_dir` inside the agent `context.py` before running.

Developing a new agent
----------------------
Follow this pattern when adding a new agent under `agents/`:
1. Create directory `agents/MyAgent/` and add files `context.py`, `graph.py`, `node_functions.py`, `prompts.md`, `output_files/`.
2. Define a Pydantic `State` model in `node_functions.py` that enumerates inputs, intermediate fields, and outputs.
3. Implement node functions: each node must accept a `State` and return a modified `State` (or async equivalents).
4. Implement a router in `graph.py` that returns the next node based on the `State`.
5. Add a debug runner (`if __name__ == '__main__'`) for quick iteration.

Testing and debugging
---------------------
- Unit testing: mock `ctx.mcp` and `ctx.llm_*` to return deterministic data. Test nodes individually by creating a minimal `State` and asserting changes.
- Integration testing: provide real MCP endpoints and credentials (avoid committing secrets). Use `documents/` guides for test patterns.
- Logs & trace: nodes append `SystemMessage` entries to `state.messages` for stepwise tracing.

Security and production notes
-----------------------------
- Never commit API keys, tokens, or credentials. Use environment variables or secret stores and mount them at runtime.
- Validate & review any SQL/YAML generated by an LLM before deploying to production.

Where to read more
------------------
- `documents/AGENTSPACES_GUIDE.md` — full usage guide (English)
- `documents/agents/DpxToClickhouse_EN.md` — DpxToClickhouse agent guide (English)
- `documents/FUNDAMENTALS_AGENT_GRAPH.md` — fundamentals: agents, graphs, state, MCP and tools

Contributing
------------
- Follow the existing patterns when adding agents.
- Add unit tests for new node logic and CI checks if available.
- Open an issue or PR with a clear description and tests for major changes.

License & contacts
------------------
- See repository root for license and project maintainers.
